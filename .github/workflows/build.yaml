name: ğŸ”§ Build Quasar Packages
on:
  push:
    paths: ['sources/**']
  schedule:
    - cron: '0 0 1 * *'  # 1-Ğ³Ğ¾ Ñ‡Ğ¸ÑĞ»Ğ° ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ğ¼ĞµÑÑÑ†Ğ°
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container: archlinux:latest

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ Setup Arch
      run: |
        pacman -Syu --noconfirm
        pacman -S --noconfirm base-devel git
        useradd -m -G wheel -s /bin/bash builder
        echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

    - name: ğŸ”¨ Build all packages
      run: |
        mkdir -p packages/QuasarLinux/x86_64

        cd sources
        for pkg in */; do
          cd "$pkg" && echo "ğŸ“¦ Building: $pkg"
          sudo -u builder makepkg -s --noconfirm --needed --clean
          cp *.pkg.tar.* ../../packages/QuasarLinux/x86_64/ 2>/dev/null || true
          cd ..
        done

    - name: ğŸ“¦ Create repo
      run: |
        cd packages/QuasarLinux/x86_64
        repo-add quasar.db.tar.gz *.pkg.tar.* 2>/dev/null || touch empty
        echo "âœ… Done: $(ls *.pkg.tar.* 2>/dev/null | wc -l) packages"

    - name: ğŸš€ Push updates
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add packages/
        git commit -m "ğŸ“¦ Monthly rebuild: $(date +%Y-%m-%d)" || echo "No changes"
        git push
