name: ðŸ”¨ QuasarLinux Package Builder

on:
  push:
    branches: [main]
    paths: ['sources/**']
  schedule:
    - cron: '0 0 1 * *'  # 1-Ð³Ð¾ Ñ‡Ð¸ÑÐ»Ð° ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð¼ÐµÑÑÑ†Ð°
  workflow_dispatch:  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº

jobs:
  build-packages:
    runs-on: ubuntu-latest
    container:
      image: archlinux/archlinux:latest
      options: --privileged  # ÐÑƒÐ¶Ð½Ð¾ Ð´Ð»Ñ makepkg

    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: ðŸ› ï¸ Setup build environment
      run: |
        # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ Ð¸ ÑÑ‚Ð°Ð²Ð¸Ð¼ Ð½ÑƒÐ¶Ð½Ñ‹Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹
        pacman -Syu --noconfirm --needed
        pacman -S --noconfirm --needed \
          base-devel \
          git \
          pacman-contrib \
          sudo

        # Ð Ð°Ð·Ñ€ÐµÑˆÐ°ÐµÐ¼ sudo Ð±ÐµÐ· Ð¿Ð°Ñ€Ð¾Ð»Ñ (Ð½ÑƒÐ¶Ð½Ð¾ Ð´Ð»Ñ makepkg)
        echo "%wheel ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

        # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° makepkg Ð´Ð»Ñ CI
        echo "MAKEFLAGS=\"-j$(nproc)\"" >> /etc/makepkg.conf
        echo "PKGEXT='.pkg.tar.zst'" >> /etc/makepkg.conf
        echo "SRCDEST=/tmp/sources" >> /etc/makepkg.conf
        echo "BUILDDIR=/tmp/build" >> /etc/makepkg.conf

        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ builder
        useradd -m -G wheel -s /bin/bash builder

    - name: ðŸ“¦ Build all packages from sources/
      run: |
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ñ‹Ñ…Ð¾Ð´Ð½ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
        mkdir -p packages/QuasarLinux/x86_64

        echo "ðŸ“ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ sources:"
        ls -la sources/

        # ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² sources
        cd sources

        # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð¿Ð°ÐºÐµÑ‚, Ð³Ð´Ðµ ÐµÑÑ‚ÑŒ PKGBUILD
        for pkg_dir in */; do
          if [ -d "$pkg_dir" ] && [ -f "${pkg_dir}PKGBUILD" ]; then
            echo "=========================================="
            echo "ðŸ”¨ Ð¡Ð±Ð¾Ñ€ÐºÐ°: $pkg_dir"
            echo "=========================================="

            # ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ð°ÐºÐµÑ‚Ð°
            cd "$pkg_dir"

            # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ð°ÐºÐµÑ‚ Ð¿Ð¾Ð´ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼ builder
            sudo -u builder makepkg -s --noconfirm --needed --clean

            # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¾Ð±Ñ€Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹ Ð² Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹
            if ls *.pkg.tar.* 1>/dev/null 2>&1; then
              echo "âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð±Ñ€Ð°Ð½Ð¾:"
              ls -la *.pkg.tar.*
              cp -v *.pkg.tar.* ../../packages/QuasarLinux/x86_64/
            else
              echo "âš ï¸  Ð¤Ð°Ð¹Ð»Ñ‹ Ð¿Ð°ÐºÐµÑ‚Ð° Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ñ‹"
            fi

            # Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ÑÑ Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð¾ Ð² sources
            cd ..
            echo ""
          fi
        done

        echo "ðŸ“Š Ð˜Ñ‚Ð¾Ð³Ð¸ ÑÐ±Ð¾Ñ€ÐºÐ¸:"
        ls -la ../packages/QuasarLinux/x86_64/*.pkg.tar.* 2>/dev/null || echo "ÐŸÐ°ÐºÐµÑ‚Ñ‹ Ð½Ðµ ÑÐ¾Ð±Ñ€Ð°Ð½Ñ‹"

    - name: ðŸ—„ï¸ Create/update repository database
      run: |
        cd packages/QuasarLinux/x86_64

        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ ÑÐ¾Ð±Ñ€Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹
        if ls *.pkg.tar.* 1>/dev/null 2>&1; then
          echo "ðŸ“¦ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ð¸Ð· ÑÐ¾Ð±Ñ€Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²..."

          # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€ÑƒÑŽ Ð‘Ð”, ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ
          rm -f quasar.db quasar.db.tar.gz quasar.files quasar.files.tar.gz

          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²ÑƒÑŽ Ð‘Ð” Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
          repo-add quasar.db.tar.gz *.pkg.tar.*

          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐ¸Ð¼Ð»Ð¸Ð½ÐºÐ¸ Ð´Ð»Ñ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸
          ln -sf quasar.db.tar.gz quasar.db
          ln -sf quasar.files.tar.gz quasar.files

          echo "âœ… Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ ÑÐ¾Ð·Ð´Ð°Ð½!"
          echo "ðŸ“ Ð¤Ð°Ð¹Ð»Ñ‹ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ:"
          ls -la quasar.*
        else
          echo "âš ï¸  ÐÐµÑ‚ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð² Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ"
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿ÑƒÑÑ‚Ð¾Ð¹ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹
          touch empty
          repo-add quasar.db.tar.gz
          ln -sf quasar.db.tar.gz quasar.db
          ln -sf quasar.files.tar.gz quasar.files
        fi

        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹ README
        cat > README.md << 'EOF'
        # QuasarLinux Pacman Repository

        ## ÐšÐ°Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ

        Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð² `/etc/pacman.conf`:

        ```ini
        [quasar]
        SigLevel = Optional TrustAll
        Server = https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/packages/QuasarLinux/$arch/
        ```

        Ð˜Ð»Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ:

        ```bash
        sudo sh -c "echo -e '\n[quasar]\nSigLevel = Optional TrustAll\nServer = https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/packages/QuasarLinux/\$arch/\n' >> /etc/pacman.conf"
        sudo pacman -Syu
        ```

        ## Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹

        ```bash
        pacman -Sl quasar
        ```

        ---

        *ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ ÑÐ±Ð¾Ñ€ÐºÐ° Ð¾Ñ‚ $(date)*
        EOF

        echo "ðŸ“„ Ð¡Ð¾Ð·Ð´Ð°Ð½ README.md"

    - name: ðŸ“¤ Commit and push repository
      run: |
        # ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ git
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

        # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð² Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹
        git add packages/QuasarLinux/x86_64/

        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
        if git diff --cached --quiet; then
          echo "â„¹ï¸  ÐÐµÑ‚ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð´Ð»Ñ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°"
        else
          # ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¸Ð¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
          git commit -m "ðŸ”§ ÐÐ²Ñ‚Ð¾ÑÐ±Ð¾Ñ€ÐºÐ° Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²: $(date +'%Y-%m-%d %H:%M')

          ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹ Ð¿Ð°ÐºÐµÑ‚Ñ‹:
          $(ls packages/QuasarLinux/x86_64/*.pkg.tar.* 2>/dev/null | xargs -I {} basename {} | tr '\n' ' ' || echo 'ÐÐµÑ‚ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²')"

          # ÐŸÑƒÑˆÐ¸Ð¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
          git push
          echo "âœ… Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð·Ð°Ð¿ÑƒÑˆÐµÐ½Ñ‹ Ð² Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹"
        fi

    - name: ðŸ“Š Summary
      if: always()
      run: |
        echo "## ðŸ“Š Ð˜Ñ‚Ð¾Ð³Ð¸ ÑÐ±Ð¾Ñ€ÐºÐ¸" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Ð”Ð°Ñ‚Ð°:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -d "packages/QuasarLinux/x86_64" ]; then
          PKG_COUNT=$(ls packages/QuasarLinux/x86_64/*.pkg.tar.* 2>/dev/null | wc -l || echo 0)
          echo "**Ð¡Ð¾Ð±Ñ€Ð°Ð½Ð¾ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²:** $PKG_COUNT" >> $GITHUB_STEP_SUMMARY

          if [ $PKG_COUNT -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            ls -la packages/QuasarLinux/x86_64/*.pkg.tar.* 2>/dev/null | awk '{print $9, $5}' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“¦ Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ:" >> $GITHUB_STEP_SUMMARY
        echo "https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/packages/QuasarLinux/x86_64/" >> $GITHUB_STEP_SUMMARY
